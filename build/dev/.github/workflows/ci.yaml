name: Tests

on:
  push:
    branches:
      - main
  pull_request: ~
  workflow_dispatch: ~

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Build Docker images
        uses: docker/bake-action@v5
        with:
          pull: true
          load: true
          files: |
            compose.test.yaml
          set: |
            *.cache-from=type=gha,scope=${{github.ref}}
            *.cache-from=type=gha,scope=refs/heads/main
            *.cache-to=type=gha,scope=${{github.ref}},mode=max
      -
        name: Start database service
        run: docker compose -f compose.test.yaml up -d postgres
      -
        name: Export host UID/GID
        run: |
          echo "HOST_UID=$(id -u)" >> "$GITHUB_ENV"
          echo "HOST_GID=$(id -g)" >> "$GITHUB_ENV"
      -
        name: Install Composer dependencies
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "export COMPOSER_HOME=/tmp/composer && mkdir -p \$COMPOSER_HOME && composer install --no-interaction --prefer-dist"
      -
        name: Create test database
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "php bin/console -e test doctrine:database:create --if-not-exists"

      -
        name: Doctrine schema update
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "php bin/console -e test doctrine:schema:update --force"
      -
        name: Load fixtures
        if: false # Set true to run tests
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "php bin/console -e test doctrine:fixtures:load --no-interaction"
      -
        name: Run Unit tests
        if: false # Set true to run tests
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "XDEBUG_MODE=off bin/phpunit --testsuite=Unit"
      -
        name: Run Integration tests
        if: false # Set true to run tests
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "XDEBUG_MODE=off bin/phpunit --testsuite=Integration"
      -
        name: Run PHPStan
        if: false # Set true to run tests
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "XDEBUG_MODE=off vendor/bin/phpstan analyse"
      -
        name: Doctrine Schema Validator
        if: false # Set true to run tests
        run: |
          set -euo pipefail
          docker compose -f compose.test.yaml run --rm \
            --user "${HOST_UID}:${HOST_GID}" \
            --workdir /app/src \
            php-fpm bash -lc "php bin/console -e test doctrine:schema:validate"

  lint:
    name: Docker Lint
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4
      -
        name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/test/Dockerfile
          ignore: "DL3018,DL4006,SC2028"